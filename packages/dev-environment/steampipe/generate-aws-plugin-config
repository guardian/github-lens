#!/usr/bin/env bash

set -e

echo "starting to generate configuration (stage=$STAGE, aws-version=$AWS_VERSION)"

STEAMPIPE_INSTALL_DIR=$HOME/.steampipe/
STEAMPIPE_CONFIG_FILE=${STEAMPIPE_INSTALL_DIR}/config/aws.spc
mkdir -p $(dirname "$STEAMPIPE_CONFIG_FILE")

if [ "$STAGE" == "DEV" ] ; then
cat << EOF > "$STEAMPIPE_CONFIG_FILE"
connection "aws" {
  plugin = "aws@${AWS_VERSION}"
  profile = "deployTools"
  regions = ["*"]
}

EOF
else
  AWS_CONFIG_FILE=$HOME/.aws/config
  mkdir -p $(dirname "$AWS_CONFIG_FILE")

  # The `cloudquery-access` role has not been provisioned in the Root account,
  # Do not configure Steampipe to use it, as it will always error with `GetCallerIdentity`.
  ROOT_ACCOUNT_NAME="Guardian Web Systems"

cat << EOF >> "$AWS_CONFIG_FILE"
[default]
region = eu-west-1

EOF

cat << EOF > "$STEAMPIPE_CONFIG_FILE"
connection "aws" {
  plugin = "aws@${AWS_VERSION}"
  type        = "aggregator"
  connections = ["aws_*"]
}

EOF

  while read -r line ; do
    ACCOUNT_NAME=$(echo "$line" | awk '{for (i=1; i<NF-1; i++) printf $i " "}' | sed 's/ $//' | sed 's/ /_/g')
    ACCOUNT_ID=$(echo "$line" | awk '{print $(NF - 1)}')

    # Steampipe doesn't like dashes, so we need to swap for underscores
    SP_NAME=$(echo "$ACCOUNT_NAME" | sed s/-/_/g)

    echo "adding config for account $ACCOUNT_NAME ($ACCOUNT_ID)"

cat << EOF >> "$AWS_CONFIG_FILE"
[profile sp_${ACCOUNT_NAME}]
role_arn = arn:aws:iam::${ACCOUNT_ID}:role/cloudquery-access
credential_source = EcsContainer
role_session_name = steampipe

EOF

cat << EOF >> "$STEAMPIPE_CONFIG_FILE"
connection "aws_${SP_NAME}" {
  plugin  = "aws@${AWS_VERSION}"
  profile = "sp_${ACCOUNT_NAME}"
  regions = ["*"]
}

EOF

  done < <(
    aws organizations list-accounts \
      --query "Accounts[?Status!='SUSPENDED' && Name!='$ROOT_ACCOUNT_NAME'].[Name,Id,Status]" \
      --output text
  )
fi
