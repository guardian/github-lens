---
kind: source
spec:
  # Source spec section
  name: 'github'
  path: 'cloudquery/github'
  version: v${CQ_GITHUB}
  skip_dependent_tables: true
  tables:
    - github_repositories
    - github_repository_branches
    - github_workflows
  destinations: ['postgresql']
  spec:
    app_auth:
      - org: guardian
        private_key_path: /private-key.pem
        app_id: '${file:/app-id}'
        installation_id: '${file:/installation-id}'
    repos: [
        # example devX owned repos
        'guardian/cdk',
        'guardian/service-catalogue',

        # example non-devX repo
        'guardian/dotcom-rendering',

        # example private repo
        'guardian/tracker',
      ]
---
kind: source
spec:
  name: 'github-teams'
  path: 'cloudquery/github'
  version: v${CQ_GITHUB}
  skip_dependent_tables: true
  tables:
    - github_teams
    - github_team_repositories
  destinations: ['postgresql']
  spec:
    app_auth:
      - org: guardian
        private_key_path: /private-key.pem
        app_id: '${file:/app-id}'
        installation_id: '${file:/installation-id}'
    orgs:
      - guardian
# ---
# kind: source
# spec:
#   name: 'aws'
#   path: 'cloudquery/aws'
#   version: v${CQ_AWS}
#   destinations: ['postgresql']
#   tables:
#     - aws_lambda_functions
#     - aws_s3_buckets
#     - aws_cloudformation_stacks
#     - aws_organizations_accounts
#     - aws_organizations_account_parents
#     - aws_organizations_organizational_units
#     - aws_ec2_instances
#     - aws_ec2_images
#   skip_dependent_tables: true
#   spec:
#     regions:
#       - eu-west-1
#       - us-east-1
#     accounts:
#       - id: 'deployTools'
#         local_profile: 'deployTools'
---
kind: source
spec:
  name: 'snyk'
  path: 'cloudquery/snyk'
  version: v${CQ_SNYK}
  destinations: ['postgresql']
  tables:
    - snyk_projects
    - snyk_issues
  spec:
    api_key: ${SNYK_TOKEN}
---
kind: source
spec:
  name: galaxies
  path: guardian/galaxies
  version: v1.1.0
  destinations:
    - postgresql
  tables:
    - galaxies_teams_table
  registry: github
  spec:
    bucket: ${GALAXIES_BUCKET}
---
kind: source
spec:
  name: 'github-languages'
  # https://github.com/guardian/cq-source-github-languages
  path: 'guardian/github-languages'
  registry: 'github'
  version: v0.0.4
  tables: ['*']
  destinations: ['postgresql']
---
kind: destination
spec:
  name: 'postgresql'
  registry: 'github'
  path: 'cloudquery/postgresql'
  version: v${CQ_POSTGRES_DESTINATION}

  # Automatically apply migrations whenever plugins are updated.
  # Note: This is not encouraged if risk averse, so we should consider removing this once fully in production.
  # See: https://www.cloudquery.io/docs/advanced-topics/managing-versions#managing-plugin-versions
  migrate_mode: 'forced'

  spec:
    connection_string: 'postgresql://postgres:not_at_all_secret@postgres:5432/postgres?sslmode=disable'
